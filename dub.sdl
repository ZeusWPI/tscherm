name "tscherm"
targetType "staticLibrary"

//sourceFiles "source/idfd/signalio/idfd_signalio_i2s_c_code.c"

dependency "bindbc-idf" version="~master" repository="git+https://github.com/Reavershark/bindbc-idf"
dependency "nobetterc" version="~master" repository="git+https://github.com/Reavershark/nobetterc"

subconfiguration "nobetterc" "minimal"


buildRequirements "allowWarnings" // Allow unknown target warning

// General flags
dflags \
    "--checkaction=C" \
    "--linkonce-templates" \
    "--fno-moduleinfo"

// Preview flags
dflags \
    "--preview=dip1000" \
    "--preview=dip1008" \
    "--preview=dip1021" \
    "--preview=bitfields" \
    "--preview=fixAliasThis" \
    "--preview=fixImmutableConv" \
    "--preview=rvaluerefparam" \
    "--preview=in"


// Build idf project
preGenerateCommands \
    "cd idf-project/${DUB_BUILD_TYPE} && ([ -f build/config/sdkconfig.h ] || idf.py configure) || true"
postBuildCommands \
    "rm idf-project/${DUB_BUILD_TYPE}/dcode.a &>/dev/null || true" \
    "(echo lib${DUB_PACKAGE}.a && dub describe --data=linker-files) | xargs ar -rcT idf-project/${DUB_BUILD_TYPE}/dcode.a" \
    "cd idf-project/${DUB_BUILD_TYPE} && idf.py build"


// ImportC preprocessor flags
dflags "-P-w"
dflags \
    "-P-D__IMPORTC__" \
    "-P-D__GLIBC_USE(arg)=0"
buildType "debug" {
    dflags "--gc" // Generate C-like debug info
    dflags "-P-I${PACKAGE_DIR}/idf-project/debug/build/config"
}
buildType "release" {
    dflags "-P-I${PACKAGE_DIR}/idf-project/release/build/config"
}
dflags \
    "-P-I/opt/esp-idf/components/app_trace/include" \
    "-P-I/opt/esp-idf/components/app_trace/include" \
    "-P-I/opt/esp-idf/components/app_update/include" \
    "-P-I/opt/esp-idf/components/app_update/include" \
    "-P-I/opt/esp-idf/components/asio/include" \
    "-P-I/opt/esp-idf/components/asio/asio/asio/include" \
    "-P-I/opt/esp-idf/components/asio/port/include" \
    "-P-I/opt/esp-idf/components/bootloader/include" \
    "-P-I/opt/esp-idf/components/bootloader_support/include" \
    "-P-I/opt/esp-idf/components/bootloader_support/include" \
    "-P-I/opt/esp-idf/components/bt/include" \
    "-P-I/opt/esp-idf/components/cbor/include" \
    "-P-I/opt/esp-idf/components/cbor/port/include" \
    "-P-I/opt/esp-idf/components/cmock/include" \
    "-P-I/opt/esp-idf/components/cmock/CMock/src" \
    "-P-I/opt/esp-idf/components/coap/include" \
    "-P-I/opt/esp-idf/components/coap/port/include" \
    "-P-I/opt/esp-idf/components/coap/port/include" \
    "-P-I/opt/esp-idf/components/coap/libcoap/include" \
    "-P-I/opt/esp-idf/components/console/include" \
    "-P-I/opt/esp-idf/components/console" \
    "-P-I/opt/esp-idf/components/cxx/include" \
    "-P-I/opt/esp-idf/components/driver/include" \
    "-P-I/opt/esp-idf/components/driver/include" \
    "-P-I/opt/esp-idf/components/driver/esp32/include" \
    "-P-I/opt/esp-idf/components/efuse/include" \
    "-P-I/opt/esp-idf/components/efuse/include" \
    "-P-I/opt/esp-idf/components/efuse/esp32/include" \
    "-P-I/opt/esp-idf/components/esp-tls/include" \
    "-P-I/opt/esp-idf/components/esp-tls" \
    "-P-I/opt/esp-idf/components/esp-tls/esp-tls-crypto" \
    "-P-I/opt/esp-idf/components/esp32/include" \
    "-P-I/opt/esp-idf/components/esp32/include" \
    "-P-I/opt/esp-idf/components/esp_adc_cal/include" \
    "-P-I/opt/esp-idf/components/esp_adc_cal/include" \
    "-P-I/opt/esp-idf/components/esp_common/include" \
    "-P-I/opt/esp-idf/components/esp_common/include" \
    "-P-I/opt/esp-idf/components/esp_eth/include" \
    "-P-I/opt/esp-idf/components/esp_eth/include" \
    "-P-I/opt/esp-idf/components/esp_event/include" \
    "-P-I/opt/esp-idf/components/esp_event/include" \
    "-P-I/opt/esp-idf/components/esp_gdbstub/include" \
    "-P-I/opt/esp-idf/components/esp_gdbstub/include" \
    "-P-I/opt/esp-idf/components/esp_hid/include" \
    "-P-I/opt/esp-idf/components/esp_hid/include" \
    "-P-I/opt/esp-idf/components/esp_http_client/include" \
    "-P-I/opt/esp-idf/components/esp_http_client/include" \
    "-P-I/opt/esp-idf/components/esp_http_server/include" \
    "-P-I/opt/esp-idf/components/esp_http_server/include" \
    "-P-I/opt/esp-idf/components/esp_https_ota/include" \
    "-P-I/opt/esp-idf/components/esp_https_ota/include" \
    "-P-I/opt/esp-idf/components/esp_https_server/include" \
    "-P-I/opt/esp-idf/components/esp_hw_support/include" \
    "-P-I/opt/esp-idf/components/esp_hw_support/include" \
    "-P-I/opt/esp-idf/components/esp_hw_support/include/soc" \
    "-P-I/opt/esp-idf/components/esp_hw_support/include/soc/esp32" \
    "-P-I/opt/esp-idf/components/esp_ipc/include" \
    "-P-I/opt/esp-idf/components/esp_ipc/include" \
    "-P-I/opt/esp-idf/components/esp_lcd/include" \
    "-P-I/opt/esp-idf/components/esp_lcd/include" \
    "-P-I/opt/esp-idf/components/esp_lcd/interface" \
    "-P-I/opt/esp-idf/components/esp_local_ctrl/include" \
    "-P-I/opt/esp-idf/components/esp_local_ctrl/include" \
    "-P-I/opt/esp-idf/components/esp_netif/include" \
    "-P-I/opt/esp-idf/components/esp_netif/include" \
    "-P-I/opt/esp-idf/components/esp_phy/include" \
    "-P-I/opt/esp-idf/components/esp_phy/include" \
    "-P-I/opt/esp-idf/components/esp_phy/esp32/include" \
    "-P-I/opt/esp-idf/components/esp_pm/include" \
    "-P-I/opt/esp-idf/components/esp_pm/include" \
    "-P-I/opt/esp-idf/components/esp_ringbuf/include" \
    "-P-I/opt/esp-idf/components/esp_ringbuf/include" \
    "-P-I/opt/esp-idf/components/esp_rom/include" \
    "-P-I/opt/esp-idf/components/esp_rom/include" \
    "-P-I/opt/esp-idf/components/esp_rom/include/esp32" \
    "-P-I/opt/esp-idf/components/esp_rom/esp32" \
    "-P-I/opt/esp-idf/components/esp_serial_slave_link/include" \
    "-P-I/opt/esp-idf/components/esp_serial_slave_link/include" \
    "-P-I/opt/esp-idf/components/esp_system/include" \
    "-P-I/opt/esp-idf/components/esp_system/include" \
    "-P-I/opt/esp-idf/components/esp_timer/include" \
    "-P-I/opt/esp-idf/components/esp_timer/include" \
    "-P-I/opt/esp-idf/components/esp_websocket_client/include" \
    "-P-I/opt/esp-idf/components/esp_websocket_client/include" \
    "-P-I/opt/esp-idf/components/esp_wifi/include" \
    "-P-I/opt/esp-idf/components/esp_wifi/include" \
    "-P-I/opt/esp-idf/components/espcoredump/include" \
    "-P-I/opt/esp-idf/components/espcoredump/include" \
    "-P-I/opt/esp-idf/components/espcoredump/include/port/xtensa" \
    "-P-I/opt/esp-idf/components/esptool_py/include" \
    "-P-I/opt/esp-idf/components/expat/include" \
    "-P-I/opt/esp-idf/components/expat/expat/expat/lib" \
    "-P-I/opt/esp-idf/components/expat/port/include" \
    "-P-I/opt/esp-idf/components/fatfs/include" \
    "-P-I/opt/esp-idf/components/fatfs/diskio" \
    "-P-I/opt/esp-idf/components/fatfs/vfs" \
    "-P-I/opt/esp-idf/components/fatfs/src" \
    "-P-I/opt/esp-idf/components/freemodbus/include" \
    "-P-I/opt/esp-idf/components/freemodbus/freemodbus/common/include" \
    "-P-I/opt/esp-idf/components/freertos/include" \
    "-P-I/opt/esp-idf/components/freertos/include" \
    "-P-I/opt/esp-idf/components/freertos/include/esp_additions/freertos" \
    "-P-I/opt/esp-idf/components/freertos/port/xtensa/include" \
    "-P-I/opt/esp-idf/components/freertos/include/esp_additions" \
    "-P-I/opt/esp-idf/components/hal/include" \
    "-P-I/opt/esp-idf/components/hal/esp32/include" \
    "-P-I/opt/esp-idf/components/hal/include" \
    "-P-I/opt/esp-idf/components/hal/platform_port/include" \
    "-P-I/opt/esp-idf/components/heap/include" \
    "-P-I/opt/esp-idf/components/heap/include" \
    "-P-I/opt/esp-idf/components/idf_test/include" \
    "-P-I/opt/esp-idf/components/idf_test/include" \
    "-P-I/opt/esp-idf/components/idf_test/include/esp32" \
    "-P-I/opt/esp-idf/components/ieee802154/include" \
    "-P-I/opt/esp-idf/components/ieee802154/include" \
    "-P-I/opt/esp-idf/components/jsmn/include" \
    "-P-I/opt/esp-idf/components/jsmn/include" \
    "-P-I/opt/esp-idf/components/json/include" \
    "-P-I/opt/esp-idf/components/json/cJSON" \
    "-P-I/opt/esp-idf/components/libsodium/include" \
    "-P-I/opt/esp-idf/components/libsodium/libsodium/src/libsodium/include" \
    "-P-I/opt/esp-idf/components/libsodium/port_include" \
    "-P-I/opt/esp-idf/components/log/include" \
    "-P-I/opt/esp-idf/components/log/include" \
    "-P-I/opt/esp-idf/components/lwip/include" \
    "-P-I/opt/esp-idf/components/lwip/include/apps" \
    "-P-I/opt/esp-idf/components/lwip/include/apps/sntp" \
    "-P-I/opt/esp-idf/components/lwip/lwip/src/include" \
    "-P-I/opt/esp-idf/components/lwip/port/esp32/include" \
    "-P-I/opt/esp-idf/components/lwip/port/esp32/include/arch" \
    "-P-I/opt/esp-idf/components/mbedtls/include" \
    "-P-I/opt/esp-idf/components/mbedtls/port/include" \
    "-P-I/opt/esp-idf/components/mbedtls/mbedtls/include" \
    "-P-I/opt/esp-idf/components/mbedtls/esp_crt_bundle/include" \
    "-P-I/opt/esp-idf/components/mdns/include" \
    "-P-I/opt/esp-idf/components/mdns/include" \
    "-P-I/opt/esp-idf/components/mqtt/include" \
    "-P-I/opt/esp-idf/components/mqtt/esp-mqtt/include" \
    "-P-I/opt/esp-idf/components/newlib/include" \
    "-P-I/opt/esp-idf/components/newlib/platform_include" \
    "-P-I/opt/esp-idf/components/nghttp/include" \
    "-P-I/opt/esp-idf/components/nghttp/port/include" \
    "-P-I/opt/esp-idf/components/nghttp/nghttp2/lib/includes" \
    "-P-I/opt/esp-idf/components/nvs_flash/include" \
    "-P-I/opt/esp-idf/components/nvs_flash/include" \
    "-P-I/opt/esp-idf/components/openssl/include" \
    "-P-I/opt/esp-idf/components/openssl/include" \
    "-P-I/opt/esp-idf/components/openthread/include" \
    "-P-I/opt/esp-idf/components/partition_table/include" \
    "-P-I/opt/esp-idf/components/perfmon/include" \
    "-P-I/opt/esp-idf/components/perfmon/include" \
    "-P-I/opt/esp-idf/components/protobuf-c/include" \
    "-P-I/opt/esp-idf/components/protobuf-c/protobuf-c" \
    "-P-I/opt/esp-idf/components/protocomm/include" \
    "-P-I/opt/esp-idf/components/protocomm/include/common" \
    "-P-I/opt/esp-idf/components/protocomm/include/security" \
    "-P-I/opt/esp-idf/components/protocomm/include/transports" \
    "-P-I/opt/esp-idf/components/pthread/include" \
    "-P-I/opt/esp-idf/components/pthread/include" \
    "-P-I/opt/esp-idf/components/sdmmc/include" \
    "-P-I/opt/esp-idf/components/sdmmc/include" \
    "-P-I/opt/esp-idf/components/soc/include" \
    "-P-I/opt/esp-idf/components/soc/include" \
    "-P-I/opt/esp-idf/components/spi_flash/include" \
    "-P-I/opt/esp-idf/components/spi_flash/include" \
    "-P-I/opt/esp-idf/components/spiffs/include" \
    "-P-I/opt/esp-idf/components/spiffs/include" \
    "-P-I/opt/esp-idf/components/tcp_transport/include" \
    "-P-I/opt/esp-idf/components/tcp_transport/include" \
    "-P-I/opt/esp-idf/components/tcpip_adapter/include" \
    "-P-I/opt/esp-idf/components/tcpip_adapter/include" \
    "-P-I/opt/esp-idf/components/tinyusb/include" \
    "-P-I/opt/esp-idf/components/ulp/include" \
    "-P-I/opt/esp-idf/components/ulp/include" \
    "-P-I/opt/esp-idf/components/unity/include" \
    "-P-I/opt/esp-idf/components/unity/include" \
    "-P-I/opt/esp-idf/components/unity/unity/src" \
    "-P-I/opt/esp-idf/components/usb/include" \
    "-P-I/opt/esp-idf/components/vfs/include" \
    "-P-I/opt/esp-idf/components/vfs/include" \
    "-P-I/opt/esp-idf/components/wear_levelling/include" \
    "-P-I/opt/esp-idf/components/wear_levelling/include" \
    "-P-I/opt/esp-idf/components/wifi_provisioning/include" \
    "-P-I/opt/esp-idf/components/wifi_provisioning/include" \
    "-P-I/opt/esp-idf/components/wpa_supplicant/include" \
    "-P-I/opt/esp-idf/components/wpa_supplicant/include" \
    "-P-I/opt/esp-idf/components/wpa_supplicant/port/include" \
    "-P-I/opt/esp-idf/components/wpa_supplicant/esp_supplicant/include" \
    "-P-I/opt/esp-idf/components/xtensa/include" \
    "-P-I/opt/esp-idf/components/xtensa/include" \
    "-P-I/opt/esp-idf/components/xtensa/esp32/include" \
    "-P-I/opt/esp-idf/components/soc/esp32/include"
configuration "esp32" {
    dflags "-P-D__XTENSA__"
    dflags "-P-I${HOME}/.espressif/tools/xtensa-esp32-elf/esp-2021r2-patch5-8.4.0/xtensa-esp32-elf/xtensa-esp32-elf/include"
}
